{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}My Cumulative Results{% endblock %}

{% block content %}
<div class="content-body">
    <div class="container-fluid">
        
        <!-- Modern Page Header -->
        {% comment %} <div class="modern-page-header fade-in">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 class="page-title-modern">My Cumulative Results</h1>
                    <p class="page-subtitle-modern">
                        <i class="fas fa-chart-area me-2"></i>
                        Track your academic progress and cumulative GPA across semesters
                    </p>
                </div>
                <div class="page-actions-modern">
                    <a href="{% url 'student_my_results' %}" class="btn-modern btn-outline-modern">
                        <i class="fas fa-table"></i>
                        Regular Results
                    </a>
                </div>
            </div>
        </div> {% endcomment %}

        {% comment %} <!-- Overall Performance Summary -->
        <div class="grid grid-cols-4 gap-4 mb-4">
            <div class="stat-card stat-card-primary">
                <div class="stat-card-header">
                    <div class="stat-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="stat-trend positive">
                        <i class="fas fa-chart-line"></i>
                        <span>CGPA</span>
                    </div>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number">{{ overall_cgpa|floatformat:3 }}</h3>
                    <p class="stat-label">Overall CGPA</p>
                    <div class="stat-progress">
                        <div class="progress-bar" style="width: {% if overall_cgpa >= 3.5 %}90{% elif overall_cgpa >= 3.0 %}75{% elif overall_cgpa >= 2.5 %}60{% elif overall_cgpa >= 2.0 %}45{% else %}25{% endif %}%"></div>
                    </div>
                    <span class="stat-description">Cumulative Grade Point Average</span>
                </div>
            </div>

            <div class="stat-card stat-card-success">
                <div class="stat-card-header">
                    <div class="stat-icon">
                        <i class="fas fa-award"></i>
                    </div>
                    <div class="stat-trend positive">
                        <i class="fas fa-medal"></i>
                        <span>CLASS</span>
                    </div>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" style="font-size: 1.2rem;">
                        {% if overall_cgpa >= 3.50 %}DIST
                        {% elif overall_cgpa >= 3.00 %}U/C
                        {% elif overall_cgpa >= 2.50 %}L/C
                        {% elif overall_cgpa >= 2.00 %}PASS
                        {% else %}FAIL
                        {% endif %}
                    </h3>
                    <p class="stat-label">Current Class</p>
                    <div class="stat-progress">
                        <div class="progress-bar" style="width: {% if overall_cgpa >= 3.5 %}100{% elif overall_cgpa >= 3.0 %}80{% elif overall_cgpa >= 2.5 %}60{% elif overall_cgpa >= 2.0 %}40{% else %}20{% endif %}%"></div>
                    </div>
                    <span class="stat-description">{{ current_remark }}</span>
                </div>
            </div>

            <div class="stat-card stat-card-info">
                <div class="stat-card-header">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-trend positive">
                        <i class="fas fa-clock"></i>
                        <span>YEAR</span>
                    </div>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number">{{ current_year }}</h3>
                    <p class="stat-label">Academic Year</p>
                    <div class="stat-progress">
                        <div class="progress-bar" style="width: 75%"></div>
                    </div>
                    <span class="stat-description">Current academic level</span>
                </div>
            </div>

            <div class="stat-card stat-card-warning">
                <div class="stat-card-header">
                    <div class="stat-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="stat-trend positive">
                        <i class="fas fa-plus"></i>
                        <span>TCU</span>
                    </div>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number">{{ total_tcu }}</h3>
                    <p class="stat-label">Total Credit Units</p>
                    <div class="stat-progress">
                        <div class="progress-bar" style="width: 85%"></div>
                    </div>
                    <span class="stat-description">Cumulative credit units</span>
                </div>
            </div>
        </div> {% endcomment %}

        <!-- GPA Classification Guide -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h2 class="card-title-modern">
                    <i class="fas fa-info-circle text-info"></i>
                    GPA Classification Guide
                </h2>
            </div>
            <div class="card-body-modern">
                <div class="grid grid-cols-5 gap-3">
                    <div class="text-center p-3 rounded" style="background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3);">
                        <div class="fw-bold text-success">Distinction</div>
                        <div class="small text-muted">3.50 - 4.00</div>
                    </div>
                    <div class="text-center p-3 rounded" style="background: rgba(23, 162, 184, 0.1); border: 1px solid rgba(23, 162, 184, 0.3);">
                        <div class="fw-bold text-info">Upper Credit</div>
                        <div class="small text-muted">3.00 - 3.49</div>
                    </div>
                    <div class="text-center p-3 rounded" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3);">
                        <div class="fw-bold text-warning">Lower Credit</div>
                        <div class="small text-muted">2.50 - 2.99</div>
                    </div>
                    <div class="text-center p-3 rounded" style="background: rgba(108, 117, 125, 0.1); border: 1px solid rgba(108, 117, 125, 0.3);">
                        <div class="fw-bold text-secondary">Pass</div>
                        <div class="small text-muted">2.00 - 2.49</div>
                    </div>
                    <div class="text-center p-3 rounded" style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3);">
                        <div class="fw-bold text-danger">Fail</div>
                        <div class="small text-muted">Below 2.00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Card -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h2 class="card-title-modern">
                    <i class="fas fa-filter text-primary"></i>
                    Filter My Results
                </h2>
            </div>
            <div class="card-body-modern">
                <form method="GET" class="grid grid-cols-auto gap-3">
                    <div class="form-group-modern">
                        <label class="form-label-modern">Level</label>
                        <select name="level" class="form-control-modern form-select-modern">
                            <option value="">All Levels</option>
                            {% for level in student_levels %}
                                <option value="{{ level.id }}" {% if selected_level == level.id|stringformat:"s" %}selected{% endif %}>
                                    {{ level.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group-modern">
                        <label class="form-label-modern">Semester</label>
                        <select name="semester" class="form-control-modern form-select-modern">
                            <option value="">All Semesters</option>
                            {% for semester in student_semesters %}
                                <option value="{{ semester.id }}" {% if selected_semester == semester.id|stringformat:"s" %}selected{% endif %}>
                                    {{ semester.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group-modern">
                        <label class="form-label-modern">&nbsp;</label>
                        <button type="submit" class="btn-modern btn-primary-modern w-100">
                            <i class="fas fa-search"></i>
                            Filter Results
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Academic Progress Summary -->
        {% if academic_years %}
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h2 class="card-title-modern">
                    <i class="fas fa-graduation-cap text-success"></i>
                    Academic Progress Summary
                </h2>
            </div>
            <div class="card-body-modern">
                <div class="grid grid-cols-auto gap-3">
                    {% for year_key, year_data in academic_years.items %}
                    <div class="text-center p-3 rounded" style="background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3);">
                        {% comment %} <div class="fw-bold text-success">{{ year_data.year }}</div> {% endcomment %}
                        <div class="h4 mb-1">{{ year_data.cgpa|floatformat:3 }}</div>
                        <div class="small text-muted">CGPA</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if selected_level and selected_semester %}
            {% if combined_results %}
            <!-- My Cumulative Results -->
        <div class="card-modern">
            <div class="card-header-modern">
                <h2 class="card-title-modern">
                    <i class="fas fa-chart-line text-success"></i>
                    My Academic Progress
                </h2>
            </div>
            <div class="card-body-modern">
                <div class="table-responsive">
                    <table class="table-modern">
                        <thead>
                            <tr>
                                <th>Semester</th>
                                <th>Level</th>
                                <th>Semester Results Used</th>
                                <th>Yearly CGPA</th>
                                <th>Overall CGPA</th>
                                {% comment %} <th>Academic Year</th> {% endcomment %}
                                <th>TCU</th>
                                <th>Cumulative TCU</th>
                                <th>Classification</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in combined_results %}
                            <tr>
                                <td>
                                    <div class="fw-semibold">{{ result.semester.name }}</div>
                                </td>
                                <td>{{ result.level.name }}</td>
                                <td>
                                    <div class="small">
                                        {% for semester_result in result.cumulative_result.result.all %}
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="text-muted">{{ semester_result.semester.name }}:</span>
                                                <span class="badge badge-sm {% if semester_result.gpa >= 3.5 %}badge-success{% elif semester_result.gpa >= 2.5 %}badge-warning{% else %}badge-danger{% endif %}">
                                                    {{ semester_result.gpa|floatformat:3 }}
                                                </span>
                                            </div>
                                        {% endfor %}
                                        {% if result.cumulative_result.result.count == 2 %}
                                            <hr class="my-1">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="fw-bold text-primary">Average:</span>
                                                <span class="badge badge-primary">{{ result.cumulative_result.yearly_cumulative_gpa|floatformat:3 }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge-modern {% if result.cumulative_result.yearly_cumulative_gpa >= 3.5 %}badge-success-modern{% elif result.cumulative_result.yearly_cumulative_gpa >= 2.5 %}badge-warning-modern{% else %}badge-danger-modern{% endif %}">
                                        {{ result.cumulative_result.yearly_cumulative_gpa|floatformat:3 }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge-modern {% if result.cumulative_result.overall_cumulative_gpa >= 3.5 %}badge-success-modern{% elif result.cumulative_result.overall_cumulative_gpa >= 2.5 %}badge-warning-modern{% else %}badge-danger-modern{% endif %}">
                                        {{ result.cumulative_result.overall_cumulative_gpa|floatformat:3 }}
                                    </span>
                                </td>
                                {% comment %} <td>
                                    <span class="badge-modern badge-info-modern">
                                        {{ result.cumulative_result.academic_year }}
                                    </span>
                                </td> {% endcomment %}
                                <td>{{ result.cumulative_result.tcu|default:"0" }}</td>
                                <td>{{ result.cumulative_result.cumulative_tcu|default:"0" }}</td>
                                <td>
                                    {% if result.cumulative_result.remark == 'distinction' %}
                                        <span class="badge-modern badge-success-modern">
                                            <i class="fas fa-star me-1"></i>Distinction
                                        </span>
                                    {% elif result.cumulative_result.remark == 'upper_credit' %}
                                        <span class="badge-modern badge-info-modern">
                                            <i class="fas fa-thumbs-up me-1"></i>Upper Credit
                                        </span>
                                    {% elif result.cumulative_result.remark == 'lower_credit' %}
                                        <span class="badge-modern badge-warning-modern">
                                            <i class="fas fa-check me-1"></i>Lower Credit
                                        </span>
                                    {% elif result.cumulative_result.remark == 'pass' %}
                                        <span class="badge-modern badge-secondary-modern">
                                            <i class="fas fa-check-circle me-1"></i>Pass
                                        </span>
                                    {% else %}
                                        <span class="badge-modern badge-danger-modern">
                                            <i class="fas fa-times me-1"></i>Fail
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

            {% else %}
            <!-- No Results Found for Selected Filters -->
            <div class="card-modern">
                <div class="card-body-modern text-center py-5">
                    <i class="fas fa-search text-muted" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h4 class="text-muted">No Cumulative Results Found</h4>
                    <p class="text-muted">No cumulative results found for the selected level and semester.</p>
                    <div class="mt-3 p-3 bg-light rounded">
                        <p class="small text-muted mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Cumulative results are only available for second semester students when both first and second semester results exist.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

        {% else %}
        <!-- Default State - No Filters Selected -->
        <div class="card-modern">
            <div class="card-body-modern text-center py-5">
                <i class="fas fa-filter text-muted" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h4 class="text-muted">Select Filters to View Results</h4>
                <p class="text-muted">Please select a level and semester above to view your cumulative results.</p>
                <div class="mt-3 p-3 bg-light rounded">
                    <p class="small text-muted mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>
                        <strong>Tip:</strong> Choose your academic level (ND1, ND2, HND1, HND2) and semester to see your cumulative GPA calculations.
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}
